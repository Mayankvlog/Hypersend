# Document 1: Namespace - hypersend
apiVersion: v1
kind: Namespace
metadata:
  name: hypersend
  labels:
    name: hypersend
    security: e2ee-enabled


---
# Document 2: ConfigMap - hypersend-config
apiVersion: v1
kind: ConfigMap
metadata:
  name: hypersend-config
  namespace: hypersend
data:
  SECRET_KEY: Prod_Secret_Key_For_Hypersend_2025_Secure_Fixed
  ALGORITHM: HS256
  ACCESS_TOKEN_EXPIRE_MINUTES: '28800'
  REFRESH_TOKEN_EXPIRE_DAYS: '20'
  UPLOAD_TOKEN_EXPIRE_HOURS: '480'
  
  # E2EE Configuration
  E2EE_ENABLED: 'true'
  E2EE_ALGORITHM: signal_protocol
  E2EE_KEY_ROTATION_DAYS: '7'
  E2EE_PREKEY_EXPIRATION_DAYS: '30'
  E2EE_MESSAGE_COUNTER_WINDOW: '1024'
  E2EE_FORWARD_SECRECYCY_ENABLED: 'true'
  E2EE_POST_COMPROMISE_SECURITY: 'true'
  
  # Device Management
  DEVICE_VERIFICATION_REQUIRED: 'true'
  DEVICE_LINKING_TIMEOUT_MINUTES: '5'
  DEVICE_SESSION_EXPIRATION_DAYS: '30'
  MAX_DEVICES_PER_USER: '4'
  
  # Message Storage (Zero-Knowledge)
  MESSAGE_STORAGE: redis_only
  MESSAGE_TTL_MINUTES: '60'
  SERVER_STORAGE_BYTES: '0'
  SERVER_TEMP_BYTES: '100000000'
  USER_DEVICE_PRIMARY: 'true'
  
  # Media Configuration
  S3_BUCKET: hypersend-temp
  AWS_ACCESS_KEY_ID: AKIA2460123456xxxxxxxx
  AWS_SECRET_ACCESS_KEY: wJalr9RiUMnits1234567stubxbdPcQxSx
  AWS_REGION: us-east-1
  FILE_TTL_HOURS: '24'
  FILE_TTL_SECONDS: '86400'
  DIRECT_S3_UPLOADS: 'true'
  DELETE_ON_ACK: 'true'
  S3_LIFECYCLE_ENABLED: 'true'
  S3_ENCRYPTION: client
  COST_MODEL: free
  MAX_FILE_SIZE_MB: '15360'
  LARGE_FILE_THRESHOLD_GB: '1'
  MAX_IMAGE_SIZE_MB: '4096'
  MAX_VIDEO_SIZE_MB: '15360'
  MAX_AUDIO_SIZE_MB: '2048'
  MAX_DOCUMENT_SIZE_MB: '15360'
  DATA_ROOT: /tmp
  UPLOADS_PATH: /tmp/uploads
  DEBUG: 'False'
  API_HOST: 0.0.0.0
  API_PORT: '8000'
  API_BASE_URL: http://localhost:8000/api/v1
  ALLOWED_ORIGINS: http://localhost:3000,https://localhost:3000
  RATE_LIMIT_PER_USER: '100'
  RATE_LIMIT_WINDOW_SECONDS: '60'
  USE_MOCK_DB: 'False'
  ENABLE_EMAIL: 'true'
  ENABLE_PASSWORD_RESET: 'true'
  SMTP_HOST: smtp.gmail.com
  SMTP_PORT: '587'
  SMTP_USERNAME: noreply@localhost.com
  SMTP_USE_TLS: 'true'
  EMAIL_FROM: noreply@localhost.com
  SENDER_NAME: Hypersend Support
  MONGODB_ATLAS_ENABLED: 'true'
  MONGODB_URI: mongodb+srv://mayanllr0311_db_user:JBkAZin8lytTK6vg@cluster0.rnj3vfd.mongodb.net/hypersend?retryWrites=true&w=majority
  REDIS_HOST: redis
  REDIS_PORT: '6379'
  REDIS_DB: '0'
  REDIS_PASSWORD: ''
  REDIS_MAX_CONNECTIONS: '100'
  REDIS_SOCKET_TIMEOUT: '5'
  REDIS_SOCKET_CONNECT_TIMEOUT: '5'
  REDIS_MAX_MEMORY: 2gb
  REDIS_KEYSPACE_ISOLATION: 'true'
  REDIS_ENCRYPTION_IN_TRANSIT: 'true'
  ABUSE_SCORING_ENABLED: 'true'
  ABUSE_SCORE_INITIAL: '0.0'
  MESSAGE_VELOCITY_LIMIT_PER_MINUTE: '100'
  MESSAGE_VELOCITY_LIMIT_PER_HOUR: '1000'
  UNIQUE_RECIPIENTS_DAILY_LIMIT: '1000'
  UNIQUE_RECIPIENTS_HOURLY_LIMIT: '100'
  SPAM_KEYWORD_SCORE_INCREMENT: '0.1'
  VELOCITY_VIOLATION_SCORE_INCREMENT: '0.15'
  REPORT_SCORE_INCREMENT: '0.2'
  SHADOW_BAN_THRESHOLD: '0.6'
  SUSPENSION_THRESHOLD: '0.85'
  SHADOW_BAN_DURATION_HOURS: '24'
  SUSPENSION_DURATION_HOURS: '168'
  SCORE_DECAY_PER_DAY: '0.1'
  MODERATION_ENABLED: 'true'
  AUTO_REPORT_THRESHOLD: '0.5'
  EXPLICIT_CONTENT_DETECTION: 'true'
  PHISHING_DETECTION: 'true'
  NGINX_ALLOW_UNSAFE_SSL: 'true'
  NGINX_API_BASE_URL: http://localhost:8000/api/v1
  NGINX_API_HOST: backend-service
  NGINX_API_KEY: hypersend_secure_api_key
  NGINX_API_SECRET: hypersend_secure_api_secret
  NGINX_PROXY_READ_TIMEOUT: '7200'
  NGINX_PROXY_SEND_TIMEOUT: '7200'
  NGINX_PROXY_CONNECT_TIMEOUT: '600'
  NGINX_CLIENT_BODY_TIMEOUT: '7200'
  NGINX_CLIENT_MAX_BODY_SIZE: 15G
  NGINX_ERROR_PAGE_TIMEOUT: '30'
  NGINX_MAX_RETRIES: '7'
  NGINX_RETRY_DELAY: '5'
  DOMAIN_NAME: localhost
  SSL_CERT_PATH: /etc/nginx/ssl/localhost/fullchain.pem
  SSL_KEY_PATH: /etc/nginx/ssl/localhost/privkey.pem


---
# Document 3: Secret - hypersend-secrets
apiVersion: v1
kind: Secret
metadata:
  name: hypersend-secrets
  namespace: hypersend
type: Opaque
data:
  # Database Secrets
  MONGO_USER: bWF5YW5sbHIwMzExX2RiX3VzZXI=
  MONGO_PASSWORD: PGRiX3Bhc3N3b3JkPg==
  MONGO_INITDB_DATABASE: aHlwZXJzZW5k
  MONGODB_ATLAS_ENABLED: dHJ1ZQ==
  MONGODB_URI: bW9uZ29kYitzcnY6Ly9tYXlhbmxscjAzMTFfZGJfdXNlcjpKQmtBWmluOGx5dFRLNnZnQGNsdXN0ZXIwLnJuajN2ZmQubW9uZ29kYi5uZXQvaHlwZXJzZW5kP3JldHJ5V3JpdGVzPXRydWUmdz1tYWpvcml0eQ==
  
  # Email Service
  SMTP_PASSWORD: ZHVtbXlfYXBwX3Bhc3N3b3JkX2NvbmZpZ3VyZV9pbl9lbnY=
  
  # AWS S3
  AWS_ACCESS_KEY_ID: QUtJQTI0NjAxMjM0NTZ4eHh4eHh4eHg=
  AWS_SECRET_ACCESS_KEY: d0phbHI5UmlVTW5pdHMxMjM0NTY3c3R1YnhiZFBjUXhTeA==
  
  # Redis
  REDIS_PASSWORD: Y2hhbmdlX3RoaXNfcGFzc3dvcmRfaW5fcHJvZA==
  
  # E2EE Secrets
  E2EE_MASTER_KEY: c2VjdXJlX2UyZWVfbWFzdGVyX2tleV8yMDI1X2ZpeGVk
  E2EE_SIGNAL_IDENTITY_KEY: c2lnbmFsX2lkZW50aXR5X2tleV9iYXNlNjRfZW5jb2RlZA==
  E2EE_SIGNAL_SIGNED_PREKEY: c2lnbmFsX3NpZ25lZF9wcmVrZXlfYmFzZTY0X2VuY29kZWQ=
  E2EE_HMAC_SECRET: aG1hY19zZWNyZXRfZm9yX2UyZWVfc2lnbmF0dXJlcw==
  E2EE_KDF_SALT: a2RmX3NhbHRfZm9yX2tleV9kZXJpdmF0aW9u
  
  # TURN Server for Voice/Video Calls
  TURN_USERNAME: dHVybnVzZXI=
  TURN_PASSWORD: Y2hhbmdlX3R1cm5fcGFzc3dvcmRfaW5fcHJvZA==
  
  # TLS Certificates (base64 encoded)
  TLS_CERTIFICATE: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tXQ==
  TLS_PRIVATE_KEY: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXQ==
  
  # Monitoring
  GRAFANA_PASSWORD: YWRtaW4=
  PROMETHEUS_ADMIN_PASSWORD: cHJvbWV0aGV1c19hZG1pbl9wYXNzd29yZA==


---
# Document 4: ConfigMap - nginx-configmap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-configmap
  namespace: hypersend
data:
  nginx.conf: "# NGINX Configuration for Hypersend\nuser nginx;\nworker_processes\
    \ auto;\nerror_log /var/log/nginx/error.log warn;\npid /var/run/nginx.pid;\n\n\
    events {\n    worker_connections 4096;\n    use epoll;\n    multi_accept on;\n\
    }\n\nhttp {\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\
    \n    log_format main '$remote_addr - $remote_user [$time_local] \"$request\"\
    \ '\n                    '$status $body_bytes_sent \"$http_referer\" '\n     \
    \               '\"$http_user_agent\" \"$http_x_forwarded_for\" '\n          \
    \          'rt=$request_time uct=\"$upstream_connect_time\" '\n              \
    \      'uht=\"$upstream_header_time\" urt=\"$upstream_response_time\"';\n    \n\
    \    access_log /var/log/nginx/access.log main buffer=32k flush=5s;\n\n    sendfile\
    \ on;\n    tcp_nopush on;\n    tcp_nodelay on;\n    keepalive_timeout 65;\n  \
    \  keepalive_requests 100;\n    \n    client_max_body_size 15G;\n    client_body_buffer_size\
    \ 10m;\n    client_header_buffer_size 4k;\n    large_client_header_buffers 4 16k;\n\
    \    \n    send_timeout 7200s;\n    proxy_connect_timeout 600s;\n    proxy_send_timeout\
    \ 7200s;\n    proxy_read_timeout 7200s;\n    \n    types_hash_max_size 2048;\n\
    \    server_names_hash_bucket_size 128;\n\n    gzip on;\n    gzip_vary on;\n \
    \   gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_min_length 1000;\n   \
    \ gzip_disable \"msie6\";\n    gzip_types text/plain text/css text/xml text/javascript\
    \ \n               application/javascript application/json application/xml+rss;\n\
    \n    add_header X-Frame-Options \"SAMEORIGIN\" always;\n    add_header X-Content-Type-Options\
    \ \"nosniff\" always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n\
    \    add_header Referrer-Policy \"strict-origin-when-cross-origin\" always;\n\n\
    \    map $http_upgrade $connection_upgrade {\n        default upgrade;\n     \
    \   '' close;\n    }\n\n    upstream backend {\n        server backend:8000 max_fails=5\
    \ fail_timeout=30s weight=100;\n        keepalive 64;\n        keepalive_requests\
    \ 200;\n        keepalive_timeout 120s;\n    }\n\n    upstream frontend {\n  \
    \      server frontend:80 max_fails=3 fail_timeout=30s weight=100;\n        keepalive\
    \ 32;\n        keepalive_requests 100;\n        keepalive_timeout 60s;\n    }\n\
    \n    resolver 127.0.0.11 valid=10s;\n    resolver_timeout 5s;\n\n    limit_req_zone\
    \ $binary_remote_addr zone=api_limit:10m rate=100r/m;\n    limit_req_zone $binary_remote_addr\
    \ zone=general_limit:10m rate=200r/m;\n    limit_req_zone $binary_remote_addr\
    \ zone=upload_limit:10m rate=20r/s;\n    limit_req_zone $binary_remote_addr zone=auth_limit:10m\
    \ rate=6r/m;\n\n    limit_req_status 429;\n\n    # Nginx Cache Configuration for\
    \ static assets and large file downloads\n    proxy_cache_path /var/cache/nginx/client_temp\
    \ levels=1:2 keys_zone=hypersend_cache:10m max_size=1g inactive=60m use_temp_path=off;\n\
    \    proxy_cache_key \"$scheme$request_method$host$request_uri\";\n    proxy_cache_valid\
    \ 200 10m;\n    proxy_cache_valid 404 1m;\n    proxy_cache_use_stale error timeout\
    \ invalid_header updating http_500 http_502 http_503 http_504;\n    proxy_cache_bypass\
    \ $http_pragma $http_authorization;\n    add_header X-Cache-Status $upstream_cache_status;\n\
    \n    # SECURITY: CORS origin allowlist map to restrict to authorized origins\n\
    \    # Production: zaply.in.net and www.zaply.in.net only\n    map $http_origin\
    \ $allowed_origin {\n        default \"\";\n        \"~^https://zaply\\.in\\.net$\"\
    \ \"https://zaply.in.net\";\n        \"~^https://www\\.zaply\\.in\\.net$\" \"\
    https://www.zaply.in.net\";\n    }\n\n    # HTTP to HTTPS redirect for production\n\
    \    server {\n        listen 80;\n        listen [::]:80;\n        server_name\
    \ zaply.in.net www.zaply.in.net;\n        \n        location / {\n           \
    \ return 301 https://$server_name$request_uri;\n        }\n        \n        location\
    \ /.well-known/acme-challenge/ {\n            root /var/www/certbot;\n       \
    \     access_log off;\n        }\n    }\n\n    # HTTP: Default fallback\n    server\
    \ {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n\
    \        server_name _;\n\n        location /health {\n            add_header\
    \ Content-Type \"text/plain\";\n            return 200 \"OK\\n\";\n          \
    \  access_log off;\n        }\n\n        location /.well-known/acme-challenge/\
    \ {\n            root /var/www/certbot;\n            access_log off;\n       \
    \ }\n\n        location /api/ {\n            limit_req zone=api_limit burst=20\
    \ nodelay;\n            proxy_pass http://backend;\n            proxy_http_version\
    \ 1.1;\n            proxy_set_header Connection $connection_upgrade;\n       \
    \     proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n\
    \            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n  \
    \          proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_set_header\
    \ Upgrade $http_upgrade;\n            proxy_buffering off;\n            proxy_read_timeout\
    \ 3600s;\n        }\n\n        location ~* \\.map$ {\n            return 404;\n\
    \            access_log off;\n        }\n\n        location / {\n            limit_req\
    \ zone=general_limit burst=40 nodelay;\n            proxy_pass http://frontend;\n\
    \            proxy_http_version 1.1;\n            proxy_set_header Connection\
    \ \"\";\n            proxy_set_header Host $host;\n            proxy_set_header\
    \ X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
    \            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_buffering\
    \ off;\n            proxy_read_timeout 300s;\n            error_page 404 =200\
    \ /index.html;\n            proxy_intercept_errors on;\n        }\n    }\n\n \
    \   # HTTPS: zaply.in.net (Production with SSL)\n    server {\n        listen\
    \ 443 ssl http2;\n        listen [::]:443 ssl http2;\n        server_name zaply.in.net\
    \ www.zaply.in.net;\n        \n        # SSL Configuration\n        ssl_certificate\
    \ /etc/nginx/ssl/zaply.in.net/fullchain.pem;\n        ssl_certificate_key /etc/nginx/ssl/zaply.in.net/privkey.pem;\n\
    \        ssl_protocols TLSv1.2 TLSv1.3;\n        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;\n\
    \        ssl_prefer_server_ciphers off;\n        ssl_session_cache shared:SSL:10m;\n\
    \        ssl_session_timeout 10m;\n        \n        # HSTS\n        add_header\
    \ Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;\n\
    \        \n        # Security headers\n        add_header Content-Security-Policy\
    \ \"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com;\
    \ style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self'\
    \ data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src\
    \ 'self' wss: https:; media-src 'self' blob:; object-src 'none';\" always;\n \
    \       add_header X-Frame-Options \"DENY\" always;\n        add_header X-Content-Type-Options\
    \ \"nosniff\" always;\n\n        location /health {\n            add_header Content-Type\
    \ \"text/plain\";\n            return 200 \"OK\\n\";\n            access_log off;\n\
    \        }\n\n        location /api/v1/files/upload {\n            limit_req zone=upload_limit\
    \ burst=200 nodelay;\n            client_max_body_size 15G;\n            \n  \
    \          #WHATSAPP EPHEMERAL STORAGE: No disk buffering\n            # - proxy_buffering\
    \ off: Don't buffer response on nginx disk\n            # - proxy_request_buffering\
    \ off: Don't buffer request on nginx disk\n            # Files stream directly\
    \ from client to backend to S3 (no server disk touch)\n            \n        \
    \    if ($request_method = 'OPTIONS') {\n                add_header 'Access-Control-Allow-Origin'\
    \ $allowed_origin always;\n                add_header 'Access-Control-Allow-Methods'\
    \ 'POST, OPTIONS' always;\n                add_header 'Access-Control-Allow-Headers'\
    \ 'Content-Type, Authorization' always;\n                add_header 'Access-Control-Allow-Credentials'\
    \ 'true' always;\n                add_header 'Access-Control-Max-Age' '3600' always;\n\
    \                add_header 'Content-Length' '0' always;\n                return\
    \ 204;\n            }\n            \n            proxy_pass http://backend;\n\
    \            proxy_http_version 1.1;\n            proxy_set_header Connection\
    \ \"\";\n            proxy_set_header Host $host;\n            proxy_set_header\
    \ X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
    \            proxy_set_header X-Forwarded-Proto https;\n            proxy_set_header\
    \ X-Forwarded-Host $server_name;\n            proxy_buffering off;\n         \
    \   proxy_request_buffering off;\n            proxy_read_timeout 3600s;\n    \
    \        \n            add_header 'Access-Control-Allow-Origin' $allowed_origin\
    \ always;\n            add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS'\
    \ always;\n            add_header 'Access-Control-Allow-Headers' 'Content-Type,\
    \ Authorization' always;\n            add_header 'Access-Control-Allow-Credentials'\
    \ 'true' always;\n        }\n        \n        location /api/v1/files/ {\n   \
    \         limit_req zone=api_limit burst=20 nodelay;\n            \n         \
    \   # WHATSAPP EPHEMERAL STORAGE: No disk buffering for downloads\n          \
    \  # proxy_buffering off: Stream responds directly without nginx disk\n      \
    \      # proxy_request_buffering off: Don't buffer requests to backend\n     \
    \       # Result: Files stream from S3 \xE2\u2020\u2019 backend \xE2\u2020\u2019\
    \ nginx \xE2\u2020\u2019 client (zero server storage)\n            \n        \
    \    if ($request_method = 'OPTIONS') {\n                add_header 'Access-Control-Allow-Origin'\
    \ $allowed_origin always;\n                add_header 'Access-Control-Allow-Methods'\
    \ 'GET, POST, OPTIONS' always;\n                add_header 'Access-Control-Allow-Headers'\
    \ 'Content-Type, Authorization' always;\n                add_header 'Access-Control-Max-Age'\
    \ '3600' always;\n                add_header 'Access-Control-Allow-Credentials'\
    \ 'true' always;\n                add_header 'Content-Length' '0' always;\n  \
    \              return 204;\n            }\n            \n            proxy_pass\
    \ http://backend;\n            proxy_http_version 1.1;\n            proxy_set_header\
    \ Connection \"\";\n            proxy_set_header Host $host;\n            proxy_set_header\
    \ X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
    \            proxy_set_header X-Forwarded-Proto https;\n            proxy_set_header\
    \ X-Forwarded-Host $server_name;\n            proxy_buffering off;\n         \
    \   proxy_request_buffering off;\n            proxy_read_timeout 3600s;\n    \
    \        \n            add_header 'Access-Control-Allow-Origin' $allowed_origin\
    \ always;\n            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS'\
    \ always;\n            add_header 'Access-Control-Allow-Headers' 'Content-Type,\
    \ Authorization' always;\n            add_header 'Access-Control-Allow-Credentials'\
    \ 'true' always;\n        }\n\n        location ~ ^/api/v1/(auth|login|register|password-reset)/?$\
    \ {\n            limit_req zone=auth_limit burst=3 nodelay;\n            proxy_pass\
    \ http://backend;\n            proxy_http_version 1.1;\n            proxy_set_header\
    \ Connection \"\";\n            proxy_set_header Host $host;\n            proxy_set_header\
    \ X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
    \            proxy_set_header X-Forwarded-Proto https;\n            proxy_read_timeout\
    \ 30s;\n        }\n\n        location /api/ {\n            limit_req zone=api_limit\
    \ burst=20 nodelay;\n            proxy_pass http://backend;\n            proxy_http_version\
    \ 1.1;\n            proxy_set_header Connection $connection_upgrade;\n       \
    \     proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n\
    \            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n  \
    \          proxy_set_header X-Forwarded-Proto https;\n            proxy_set_header\
    \ X-Forwarded-Host $server_name;\n            proxy_set_header X-Forwarded-Port\
    \ 443;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_buffering\
    \ off;\n            proxy_request_buffering off;\n            proxy_next_upstream\
    \ error timeout http_502 http_503 http_504;\n            proxy_next_upstream_tries\
    \ 2;\n            proxy_next_upstream_timeout 30s;\n            proxy_read_timeout\
    \ 3600s;\n        }\n\n        location ~* \\.map$ {\n            proxy_pass http://frontend;\n\
    \            proxy_http_version 1.1;\n            proxy_set_header Connection\
    \ \"\";\n            proxy_set_header Host $host;\n            proxy_set_header\
    \ X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
    \            proxy_set_header X-Forwarded-Proto https;\n            proxy_buffering\
    \ off;\n            proxy_read_timeout 300s;\n            proxy_intercept_errors\
    \ off;\n            proxy_cache hypersend_cache;\n            proxy_cache_valid\
    \ 200 24h;\n            add_header Cache-Control \"public, max-age=31536000\"\
    \ always;\n            add_header X-Content-Type-Options \"nosniff\" always;\n\
    \            add_header X-Cache-Status $upstream_cache_status always;\n      \
    \  }\n\n        location / {\n            limit_req zone=general_limit burst=40\
    \ nodelay;\n            proxy_pass http://frontend;\n            proxy_http_version\
    \ 1.1;\n            proxy_set_header Connection \"\";\n            proxy_set_header\
    \ Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n        \
    \    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n          \
    \  proxy_set_header X-Forwarded-Proto https;\n            proxy_buffering off;\n\
    \            proxy_read_timeout 300s;\n            error_page 404 =200 /index.html;\n\
    \            proxy_intercept_errors on;\n        }\n    }\n}\n"


---
# Document 5: StatefulSet - redis-cluster
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  namespace: hypersend
spec:
  serviceName: redis-cluster
  replicas: 3
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        resources:
          requests:
            memory: 1Gi
            cpu: 500m
          limits:
            memory: 2Gi
            cpu: 1000m
        command:
        - redis-server
        - --appendonly no
        - --save ""
        - --maxmemory 1gb
        - --maxmemory-policy allkeys-lru
        - --cluster-enabled yes
        - --cluster-config-file nodes.conf
        - --cluster-node-timeout 5000
        - --cluster-announce-ip $(POD_IP)
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        livenessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
  volumeClaimTemplates:
  - metadata:
      name: redis-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi


---
# Document 6: Deployment - backend-api
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-api
  namespace: hypersend
spec:
  replicas: 10
  selector:
    matchLabels:
      app: backend-api
  template:
    metadata:
      labels:
        app: backend-api
    spec:
      containers:
      - name: backend
        image: ghcr.io/mayankvlog/hypersend-backend:latest
        ports:
        - containerPort: 8000
        resources:
          requests:
            memory: 512Mi
            cpu: 250m
          limits:
            memory: 1Gi
            cpu: 500m
        env:
        - name: REDIS_HOST
          value: redis-cluster
        - name: REDIS_PORT
          value: '6379'
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: hypersend-secrets
              key: mongodb-uri
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: hypersend-secrets
              key: secret-key
        - name: S3_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: hypersend-secrets
              key: s3-endpoint
        - name: S3_BUCKET
          value: hypersend-media
        - name: MAX_FILE_SIZE_BYTES
          value: '16106127360'
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - sleep 15


---
# Document 7: Deployment - websocket-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: websocket-service
  namespace: hypersend
spec:
  replicas: 20
  selector:
    matchLabels:
      app: websocket-service
  template:
    metadata:
      labels:
        app: websocket-service
    spec:
      containers:
      - name: websocket
        image: hypersend/websocket:latest
        ports:
        - containerPort: 8001
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 250m
        env:
        - name: REDIS_HOST
          value: redis-cluster
        - name: BACKEND_URL
          value: http://backend-api:8000
        - name: MAX_CONNECTIONS
          value: '10000'
        livenessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 5
          periodSeconds: 5


---
# Document 8: Deployment - nginx-lb
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-lb
  namespace: hypersend
spec:
  replicas: 5
  selector:
    matchLabels:
      app: nginx-lb
  template:
    metadata:
      labels:
        app: nginx-lb
    spec:
      containers:
      - name: nginx
        image: nginx:1.25-alpine
        ports:
        - containerPort: 80
        - containerPort: 443
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 250m
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: ssl-certs
          mountPath: /etc/ssl/certs
          readOnly: true
        - name: nginx-cache
          mountPath: /var/cache/nginx/client_temp
          readOnly: false
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: ssl-certs
        secret:
          secretName: ssl-certs
      - name: nginx-cache
        persistentVolumeClaim:
          claimName: nginx-cache


---
# Document 9: Deployment - frontend
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: hypersend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: ghcr.io/mayankvlog/hypersend-frontend:latest
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: 128Mi
            cpu: 50m
          limits:
            memory: 512Mi
            cpu: 200m
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10


---
# Document 10: PersistentVolumeClaim - nginx-cache
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nginx-cache
  namespace: hypersend
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi


---
# Document 11: Service - backend-api
apiVersion: v1
kind: Service
metadata:
  name: backend-api
  namespace: hypersend
spec:
  selector:
    app: backend-api
  ports:
  - port: 8000
    targetPort: 8000
  type: ClusterIP


---
# Document 12: HorizontalPodAutoscaler - backend-api-hpa
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-api-hpa
  namespace: hypersend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend-api
  minReplicas: 3
  maxReplicas: 100
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 70
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 10
        periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 600
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
      selectPolicy: Min


---
# Document 14: Service - websocket-service
apiVersion: v1
kind: Service
metadata:
  name: websocket-service
  namespace: hypersend
spec:
  selector:
    app: websocket-service
  ports:
  - port: 8001
    targetPort: 8001
  type: ClusterIP


---
# Document 15: HorizontalPodAutoscaler - websocket-hpa
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: websocket-hpa
  namespace: hypersend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: websocket-service
  minReplicas: 7
  maxReplicas: 100
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 70
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
      - type: Percent
        value: 200
        periodSeconds: 10
      - type: Pods
        value: 20
        periodSeconds: 10
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 600
      policies:
      - type: Percent
        value: 5
        periodSeconds: 60


---
# Document 16: HorizontalPodAutoscaler - crypto-worker-hpa
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: crypto-worker-hpa
  namespace: hypersend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: crypto-worker
  minReplicas: 4
  maxReplicas: 50
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 10
        periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 30
      selectPolicy: Min


---
# Document 17: Deployment - crypto-worker
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crypto-worker
  namespace: hypersend
  labels:
    app: crypto-worker
spec:
  replicas: 4
  selector:
    matchLabels:
      app: crypto-worker
  template:
    metadata:
      labels:
        app: crypto-worker
    spec:
      containers:
      - name: crypto-worker
        image: hypersend/crypto-worker:latest
        resources:
          requests:
            memory: 512Mi
            cpu: 250m
          limits:
            memory: 2Gi
            cpu: 1000m
        env:
        - name: REDIS_HOST
          value: redis-cluster
        - name: REDIS_PORT
          value: '6379'
        - name: WORKER_THREADS
          value: '4'
        - name: CRYPTO_ALGORITHM
          value: Signal
        livenessProbe:
          exec:
            command:
            - python
            - -c
            - import redis; r=redis.Redis(host='redis-cluster'); r.ping()
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          exec:
            command:
            - python
            - -c
            - import redis; r=redis.Redis(host='redis-cluster'); r.ping()
          initialDelaySeconds: 10
          periodSeconds: 10
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL


---
# Document 18: Service - nginx-lb
apiVersion: v1
kind: Service
metadata:
  name: nginx-lb
  namespace: hypersend
spec:
  selector:
    app: nginx-lb
  ports:
  - port: 80
    targetPort: 80
  - port: 443
    targetPort: 443
  type: LoadBalancer


---
# Document 19: Service - redis-cluster
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster
  namespace: hypersend
spec:
  selector:
    app: redis-cluster
  ports:
  - port: 6379
    targetPort: 6379
  type: ClusterIP
  clusterIP: None


---
# Document 20: PodDisruptionBudget - backend-api-pdb
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: backend-api-pdb
  namespace: hypersend
spec:
  minAvailable: 60%
  selector:
    matchLabels:
      app: backend-api


---
# Document 21: PodDisruptionBudget - websocket-pdb
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: websocket-pdb
  namespace: hypersend
spec:
  minAvailable: 70%
  selector:
    matchLabels:
      app: websocket-service


---
# Document 22: PodDisruptionBudget - crypto-worker-pdb
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: crypto-worker-pdb
  namespace: hypersend
spec:
  minAvailable: 50%
  selector:
    matchLabels:
      app: crypto-worker


---
# Document 23: PodDisruptionBudget - fan-out-worker-pdb
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: fan-out-worker-pdb
  namespace: hypersend
spec:
  minAvailable: 50%
  selector:
    matchLabels:
      app: fan-out-worker


---
# Document 24: PodDisruptionBudget - nginx-pdb
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: nginx-pdb
  namespace: hypersend
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: nginx-lb


---
# Document 25: NetworkPolicy - hypersend-network-policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hypersend-network-policy
  namespace: hypersend
spec:
  podSelector:
    matchLabels: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: hypersend
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: hypersend


---
# Document 26: ResourceQuota - hypersend-quota
apiVersion: v1
kind: ResourceQuota
metadata:
  name: hypersend-quota
  namespace: hypersend
spec:
  hard:
    requests.cpu: '20'
    requests.memory: 20Gi
    limits.cpu: '40'
    limits.memory: 40Gi
    persistentvolumeclaims: '0'
    pods: '100'
    services: '10'
    secrets: '10'
    configmaps: '10'


---
# Document 27: LimitRange - hypersend-limits
apiVersion: v1
kind: LimitRange
metadata:
  name: hypersend-limits
  namespace: hypersend
spec:
  limits:
  - type: Container
    max:
      cpu: '2'
      memory: 2Gi
    min:
      cpu: 100m
      memory: 128Mi
    default:
      cpu: 500m
      memory: 1Gi
    defaultRequest:
      cpu: 100m
      memory: 256Mi


---
# Document 28: Deployment - background-workers
apiVersion: apps/v1
kind: Deployment
metadata:
  name: background-workers
  namespace: hypersend
  labels:
    app: background-workers
spec:
  replicas: 2
  selector:
    matchLabels:
      app: background-workers
  template:
    metadata:
      labels:
        app: background-workers
    spec:
      containers:
      - name: worker
        image: hypersend/backend:latest
        command:
        - python
        - -m
        - celery
        - worker
        - -A
        - backend.celery_app
        - --loglevel=info
        - --concurrency=4
        env:
        - name: REDIS_HOST
          value: redis-cluster
        - name: REDIS_PORT
          value: '6379'
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: hypersend-secrets
              key: REDIS_PASSWORD
        - name: ENVIRONMENT
          value: production
        - name: CELERY_BROKER_URL
          value: redis://redis-cluster:6379/0
        - name: CELERY_RESULT_BACKEND
          value: redis://redis-cluster:6379/0
        - name: WORKER_CONCURRENCY
          value: '4'
        - name: WORKER_PREFETCH_MULTIPLIER
          value: '1'
        - name: WORKER_MAX_TASKS_PER_CHILD
          value: '1000'
        - name: MEDIA_CLEANUP_INTERVAL
          value: '300'
        - name: MESSAGE_CLEANUP_INTERVAL
          value: '600'
        - name: ACK_RECONCILIATION_INTERVAL
          value: '180'
        - name: CLEANUP_BATCH_SIZE
          value: '100'
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 1Gi
            cpu: 500m
        livenessProbe:
          exec:
            command:
            - python
            - -c
            - import redis; r=redis.Redis(host='redis-cluster', password='${REDIS_PASSWORD}');
              r.ping()
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          exec:
            command:
            - python
            - -c
            - import redis; r=redis.Redis(host='redis-cluster', password='${REDIS_PASSWORD}');
              r.ping()
          initialDelaySeconds: 10
          periodSeconds: 10
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL


---
# Document 29: HorizontalPodAutoscaler - background-workers-hpa
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: background-workers-hpa
  namespace: hypersend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: background-workers
  minReplicas: 2
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 5
        periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 25
        periodSeconds: 60
      selectPolicy: Min


---
# Document 30: PodDisruptionBudget - background-workers-pdb
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: background-workers-pdb
  namespace: hypersend
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: background-workers


---
# Document 31: NetworkPolicy - hypersend-media-policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hypersend-media-policy
  namespace: hypersend
spec:
  podSelector:
    matchLabels:
      app: background-workers
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: hypersend
    ports:
    - protocol: TCP
      port: 6379
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: hypersend
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 9000
    - protocol: TCP
      port: 443


---
# Document 32: Deployment - e2ee-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: e2ee-service
  namespace: hypersend
  labels:
    app: e2ee-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: e2ee-service
  template:
    metadata:
      labels:
        app: e2ee-service
    spec:
      containers:
      - name: e2ee-service
        image: ghcr.io/mayankvlog/hypersend-backend:latest
        command:
        - python
        - -m
        - uvicorn
        - backend.e2ee_service:app
        - --host
        - "0.0.0.0"
        - --port
        - "8002"
        ports:
        - containerPort: 8002
          name: http
        resources:
          requests:
            memory: 512Mi
            cpu: 500m
          limits:
            memory: 1Gi
            cpu: 1000m
        env:
        - name: REDIS_HOST
          value: redis-cluster
        - name: ENABLE_E2EE
          value: "true"
        - name: MAX_E2EE_DEVICES
          value: "4"
        - name: E2EE_SESSION_TIMEOUT
          value: "604800"
        - name: ENABLE_KEY_ROTATION
          value: "true"
        livenessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 30
          periodSeconds: 10


---
# Document 33: Service - e2ee-service
apiVersion: v1
kind: Service
metadata:
  name: e2ee-service
  namespace: hypersend
spec:
  selector:
    app: e2ee-service
  ports:
  - port: 8002
    targetPort: 8002
  type: ClusterIP


---
# Document 34: HorizontalPodAutoscaler - e2ee-service-hpa
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: e2ee-service-hpa
  namespace: hypersend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: e2ee-service
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70


---
# Document 35: ServiceAccount - e2ee-service-account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: e2ee-service-account
  namespace: hypersend


---
# Document 36: Secret - e2ee-encryption-keys
apiVersion: v1
kind: Secret
metadata:
  name: e2ee-encryption-keys
  namespace: hypersend
type: Opaque
stringData:
  MASTER_KEY: hypersend_master_key_change_this_in_prod
  BACKUP_ENCRYPTION_KEY: hypersend_backup_encryption_key_change_this
  DEVICE_LINKING_KEY: hypersend_device_linking_key_change_this


---
# Document 37: PodDisruptionBudget - e2ee-service-pdb
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: e2ee-service-pdb
  namespace: hypersend
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: e2ee-service


---
# Document 38: HorizontalPodAutoscaler - e2ee-service-hpa
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: e2ee-service-hpa
  namespace: hypersend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: e2ee-service
  minReplicas: 2
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
      - type: Percent
        value: 200
        periodSeconds: 15
      - type: Pods
        value: 10
        periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 25
        periodSeconds: 60
      selectPolicy: Min


---
# Document 39: Deployment - turn-server (for voice/video calls)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: turn-server
  namespace: hypersend
  labels:
    app: turn-server
    tier: infrastructure
spec:
  replicas: 2
  selector:
    matchLabels:
      app: turn-server
  template:
    metadata:
      labels:
        app: turn-server
        tier: infrastructure
    spec:
      containers:
      - name: coturn
        image: coturn/coturn:latest
        ports:
        - containerPort: 3478
          name: turn-udp
          protocol: UDP
        - containerPort: 3478
          name: turn-tcp
          protocol: TCP
        - containerPort: 5349
          name: turn-tls
          protocol: TCP
        env:
        - name: TURNSERVER_ENABLED
          value: "1"
        - name: TURNSERVER_REALM
          value: "hypersend.local"
        - name: TURNSERVER_USERNAME
          valueFrom:
            secretKeyRef:
              name: hypersend-secrets
              key: TURN_USERNAME
        - name: TURNSERVER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: hypersend-secrets
              key: TURN_PASSWORD
        - name: TURNSERVER_EXTERNAL_IP
          value: "$(SERVICE_HOST)"
        - name: TURNSERVER_LOG_LEVEL
          value: "warning"
        - name: TURNSERVER_VERBOSE
          value: "0"
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          udpSocket:
            port: 3478
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          udpSocket:
            port: 3478
          initialDelaySeconds: 5
          periodSeconds: 5
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000


---
# Document 40: Service - turn-server
apiVersion: v1
kind: Service
metadata:
  name: turn-server
  namespace: hypersend
  labels:
    app: turn-server
spec:
  selector:
    app: turn-server
  ports:
  - name: turn-udp
    port: 3478
    targetPort: 3478
    protocol: UDP
  - name: turn-tcp
    port: 3478
    targetPort: 3478
    protocol: TCP
  - name: turn-tls
    port: 5349
    targetPort: 5349
    protocol: TCP
  type: LoadBalancer


---
# Document 41: HorizontalPodAutoscaler - turn-server-hpa
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: turn-server-hpa
  namespace: hypersend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: turn-server
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 70
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 2
        periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 25
        periodSeconds: 60
      selectPolicy: Min


---
# Document 42: PersistentVolumeClaim - e2ee-storage
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: e2ee-storage-pvc
  namespace: hypersend
  labels:
    app: e2ee-service
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: fast-ssd


---
# Document 43: NetworkPolicy - e2ee-security-policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: e2ee-security-policy
  namespace: hypersend
spec:
  podSelector:
    matchLabels:
      app: e2ee-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: hypersend
    - podSelector:
        matchLabels:
          app: backend
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8000
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: hypersend
    - podSelector:
        matchLabels:
          app: redis
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 27017
