name: Production Deployment Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - 'nginx.conf'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_BACKEND: hypersend-backend
  IMAGE_FRONTEND: hypersend-frontend
  REGISTRY: docker.io

jobs:
  # ============================================================================
  # STAGE 1: BUILD & PUSH DOCKER IMAGES
  # ============================================================================
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    outputs:
      backend-tag: ${{ steps.meta-backend.outputs.tags }}
      frontend-tag: ${{ steps.meta-frontend.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_BACKEND }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_BACKEND }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_BACKEND }}:${{ github.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_BACKEND }}:${{ github.ref_name }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_BACKEND }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_BACKEND }}:buildcache,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      - name: Generate metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_FRONTEND }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_FRONTEND }}:${{ github.ref_name }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_FRONTEND }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_FRONTEND }}:buildcache,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      - name: Image digest
        run: |
          echo "Backend image pushed: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_BACKEND }}:${{ github.sha }}"
          echo "Frontend image pushed: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_FRONTEND }}:${{ github.sha }}"

  # ============================================================================
  # STAGE 2: DEPLOY TO VPS
  # ============================================================================
  deploy:
    name: Deploy to DigitalOcean VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://${{ secrets.VPS_HOST }}:8000
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘         HyperSend Production Deployment Started            â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Navigate to project directory
            cd /root/Hypersend || { echo "âŒ Project directory not found"; exit 1; }
            
            echo "ðŸ“¦ Step 1: Pulling latest code..."
            git pull origin main || { echo "âŒ Git pull failed"; exit 1; }
            
            echo "ðŸ” Step 2: Logging into DockerHub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || { echo "âŒ DockerHub login failed"; exit 1; }
            
            echo "â¬‡ï¸  Step 3: Pulling latest Docker images..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_BACKEND }}:latest || { echo "âŒ Backend image pull failed"; exit 1; }
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_FRONTEND }}:latest || { echo "âŒ Frontend image pull failed"; exit 1; }
            
            echo "ðŸ›‘ Step 4: Stopping old containers..."
            docker-compose down || true
            
            echo "ðŸš€ Step 5: Starting new containers..."
            docker-compose up -d || { echo "âŒ Container startup failed"; exit 1; }
            
            echo "â³ Step 6: Waiting for services to be ready..."
            sleep 10
            
            echo "ðŸ§¹ Step 7: Cleaning up old images..."
            docker image prune -af --filter "until=72h" || true
            
            echo "ðŸ“Š Step 8: Checking container status..."
            docker-compose ps
            
            echo ""
            echo "ðŸ“ Step 9: Recent logs (last 30 lines)..."
            docker-compose logs --tail=30 backend || true
            
            echo ""
            echo "âœ… Deployment completed successfully!"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Wait for services to stabilize
        run: |
          echo "â³ Waiting 30 seconds for services to stabilize..."
          sleep 30

  # ============================================================================
  # STAGE 3: HEALTH CHECKS & VERIFICATION
  # ============================================================================
  health-check:
    name: Health Check & Verification
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Check backend health
        run: |
          echo "ðŸ¥ Checking backend health..."
          for i in {1..10}; do
            if curl -f http://${{ secrets.VPS_HOST }}:8000/health 2>/dev/null | grep -q "healthy"; then
              echo "âœ… Backend is healthy!"
              exit 0
            fi
            echo "â³ Attempt $i/10 - Waiting for backend..."
            sleep 5
          done
          echo "âŒ Backend health check failed!"
          exit 1

      - name: Check API endpoints
        run: |
          echo "ðŸ” Checking API endpoints..."
          
          # Check docs endpoint
          if curl -f http://${{ secrets.VPS_HOST }}:8000/docs > /dev/null 2>&1; then
            echo "âœ… API docs endpoint working"
          else
            echo "âš ï¸  API docs endpoint not responding"
          fi
          
          # Check health endpoint
          if curl -f http://${{ secrets.VPS_HOST }}:8000/health > /dev/null 2>&1; then
            echo "âœ… Health endpoint working"
          else
            echo "âŒ Health endpoint failed"
            exit 1
          fi

      - name: Verify Docker containers
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "ðŸ³ Verifying Docker containers..."
            
            # Check if containers are running
            BACKEND=$(docker-compose ps backend | grep -c "Up" || echo "0")
            FRONTEND=$(docker-compose ps frontend | grep -c "Up" || echo "0")
            
            if [ "$BACKEND" -eq 1 ] && [ "$FRONTEND" -eq 1 ]; then
              echo "âœ… All containers are running"
            else
              echo "âŒ Some containers are not running"
              docker-compose ps
              exit 1
            fi
            
            # Check for errors in logs
            if docker-compose logs backend | grep -i "error" | head -5; then
              echo "âš ï¸  Errors found in logs"
            else
              echo "âœ… No critical errors in logs"
            fi

  # ============================================================================
  # STAGE 4: NOTIFICATIONS
  # ============================================================================
  notify:
    name: Send Notifications
    needs: [build-and-push, deploy, health-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [ "${{ needs.build-and-push.result }}" == "success" ] && \
             [ "${{ needs.deploy.result }}" == "success" ] && \
             [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
            echo "color=00FF00" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "color=FF0000" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Push | ${{ needs.build-and-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access Points:**" >> $GITHUB_STEP_SUMMARY
          echo "- API: http://${{ secrets.VPS_HOST }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "- Docs: http://${{ secrets.VPS_HOST }}:8000/docs" >> $GITHUB_STEP_SUMMARY
          echo "- Health: http://${{ secrets.VPS_HOST }}:8000/health" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification (if configured)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "HyperSend Deployment ${{ steps.status.outputs.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*HyperSend Production Deployment* ${{ steps.status.outputs.status }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ============================================================================
  # STAGE 5: PERFORMANCE MONITORING
  # ============================================================================
  performance-check:
    name: Performance Monitoring
    needs: health-check
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Check system resources
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "ðŸ“Š Performance Metrics"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            
            echo "ðŸ’¾ Memory Usage:"
            free -h | grep Mem
            
            echo ""
            echo "ðŸ’¿ Disk Usage:"
            df -h | grep -E "Filesystem|/dev/vda"
            
            echo ""
            echo "ðŸ³ Docker Stats:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" || true
            
            echo ""
            echo "ðŸŒ Active Connections:"
            echo "Backend (8000): $(netstat -an 2>/dev/null | grep :8000 | wc -l) connections"
            echo "Frontend (8550): $(netstat -an 2>/dev/null | grep :8550 | wc -l) connections"
            
            echo ""
            echo "âœ… Performance check completed"
