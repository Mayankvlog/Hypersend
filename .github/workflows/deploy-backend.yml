name: Build & Deploy Backend

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/hypersend-backend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy to VPS (Docker Compose, password SSH)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e
            cd /hypersend/Hypersend || { echo "‚ùå Directory /hypersend/Hypersend not found"; exit 1; }

            echo "üì¶ Starting backend deployment..."

            # Safely sync repo with remote without creating merge commits
            # (keeps untracked files like .env, but resets tracked files to origin/main)
            echo "üîÑ Syncing repository..."
            git fetch origin main
            git reset --hard origin/main

            # Pull latest backend image
            echo "üì• Pulling backend image..."
            docker compose pull backend || { echo "‚ö†Ô∏è Image pull had issues, continuing..."; }

            # Stop the backend service (don't fail if it's already stopped)
            echo "‚èπÔ∏è  Stopping backend service..."
            docker compose down --remove-orphans 2>/dev/null || true
            
            # Wait a moment for processes to fully terminate
            sleep 2

            # Clean up any dangling containers/images from previous deployments
            echo "üßπ Cleaning up dangling containers..."
            docker container prune -f --filter "until=1h" 2>/dev/null || true
            docker image prune -f 2>/dev/null || true

            # Start the backend service with retry logic
            echo "üöÄ Starting backend service..."
            n=0
            until [ "$n" -ge 3 ]; do
              if docker compose up -d backend; then
                echo "‚úÖ Backend service started successfully"
                break
              fi

              echo "‚ö†Ô∏è  Attempt $((n+1)) failed, waiting 3s and retrying..."
              n=$((n+1))
              sleep 3
            done

            if [ "$n" -ge 3 ]; then
              echo "‚ùå Failed to start backend service after multiple attempts"
              docker compose logs backend || true
              exit 1
            fi

            # Wait for service to be healthy
            echo "‚è≥ Waiting for backend to be healthy..."
            max_attempts=30
            attempt=0
            while [ $attempt -lt $max_attempts ]; do
              if docker compose exec -T backend curl -f http://localhost:8000/health 2>/dev/null || true; then
                echo "‚úÖ Backend is healthy"
                break
              fi
              attempt=$((attempt+1))
              if [ $attempt -lt $max_attempts ]; then
                sleep 2
              fi
            done

            if [ $attempt -eq $max_attempts ]; then
              echo "‚ö†Ô∏è  Backend health check timeout, but service is running"
            fi

            echo "‚ú® Deployment completed successfully!"
