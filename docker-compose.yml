networks:
  hypersend_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis_data:
    driver: local
  nginx_cache:
    driver: local
  uploads_data:
    driver: local
  ssl_certs:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

services:
  # =============================================================================
  # NGINX Load Balancer with SSL Termination
  # =============================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: hypersend_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ssl_certs:/etc/ssl/certs:ro
      - nginx_cache:/var/cache/nginx
      - uploads_data:/data/uploads:ro
    environment:
      - NGINX_ALLOW_UNSAFE_SSL=true
      - NGINX_API_BASE_URL=${API_BASE_URL:-https://zaply.in.net/api/v1}
      - NGINX_API_HOST=backend
      - NGINX_API_KEY=${NGINX_API_KEY:-hypersend_secure_api_key}
      - NGINX_API_SECRET=${NGINX_API_SECRET:-hypersend_secure_api_secret}
      - NGINX_PROXY_READ_TIMEOUT=7200
      - NGINX_PROXY_SEND_TIMEOUT=7200
      - NGINX_PROXY_CONNECT_TIMEOUT=600
      - NGINX_CLIENT_BODY_TIMEOUT=7200
      - NGINX_CLIENT_MAX_BODY_SIZE=15G
      - DOMAIN_NAME=${DOMAIN_NAME:-zaply.in.net}
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    networks:
      - hypersend_network
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f -s http://127.0.0.1/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # Redis Cluster - Ephemeral Cache for Real-time Operations
  # =============================================================================
  redis:
    image: redis:7.2-alpine
    container_name: hypersend_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: >
      redis-server 
      --appendonly no 
      --save "" 
      --maxmemory 2gb 
      --maxmemory-policy allkeys-lru
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
    volumes:
      - redis_data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-change_this_in_production}
    networks:
      - hypersend_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    sysctls:
      - net.core.somaxconn=65535

  # =============================================================================
  # Backend API Service - Production Ready
  # =============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: mayank035/hypersend-backend:latest
    container_name: hypersend_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    command: uvicorn backend.main:app --host 0.0.0.0 --port 8000 --workers 4 --loop uvloop --http httptools
    environment:
      # Core Configuration
      - SECRET_KEY=${SECRET_KEY:-Prod_Secret_Key_For_Hypersend_2025_Secure_Fixed}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=28800
      - REFRESH_TOKEN_EXPIRE_DAYS=20
      - UPLOAD_TOKEN_EXPIRE_HOURS=480
      
      # E2EE Configuration
      - E2EE_ENABLED=true
      - E2EE_ALGORITHM=signal_protocol
      - E2EE_KEY_ROTATION_DAYS=7
      - E2EE_PREKEY_EXPIRATION_DAYS=30
      - E2EE_MESSAGE_COUNTER_WINDOW=1024
      - E2EE_FORWARD_SECRECYCY_ENABLED=true
      - E2EE_POST_COMPROMISE_SECURITY=true
      
      # Device Management
      - DEVICE_VERIFICATION_REQUIRED=true
      - DEVICE_LINKING_TIMEOUT_MINUTES=5
      - DEVICE_SESSION_EXPIRATION_DAYS=30
      - MAX_DEVICES_PER_USER=4
      
      # Message Storage (Zero-Knowledge)
      - MESSAGE_STORAGE=redis_only
      - MESSAGE_TTL_MINUTES=60
      - SERVER_STORAGE_BYTES=0
      - SERVER_TEMP_BYTES=100000000
      - USER_DEVICE_PRIMARY=true
      
      # Media Configuration
      - S3_BUCKET=${S3_BUCKET:-hypersend-temp}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - FILE_TTL_HOURS=24
      - FILE_TTL_SECONDS=86400
      - DIRECT_S3_UPLOADS=true
      - DELETE_ON_ACK=true
      - S3_LIFECYCLE_ENABLED=true
      - S3_ENCRYPTION=client
      - COST_MODEL=free
      - MAX_FILE_SIZE_MB=15360
      - LARGE_FILE_THRESHOLD_GB=1
      - MAX_IMAGE_SIZE_MB=4096
      - MAX_VIDEO_SIZE_MB=15360
      - MAX_AUDIO_SIZE_MB=2048
      - MAX_DOCUMENT_SIZE_MB=15360
      
      # Database Configuration
      - DATA_ROOT=/data
      - UPLOADS_PATH=/app/uploads
      - MONGODB_ATLAS_ENABLED=true
      - MONGODB_URI=${MONGODB_URI:-mongodb+srv://mayanllr0311_db_user:JBkAZin8lytTK6vg@cluster0.rnj3vfd.mongodb.net/hypersend?retryWrites=true&w=majority}
      - MONGO_USER=${MONGO_USER:-mayanllr0311_db_user}
      - MONGO_PASSWORD=${MONGO_PASSWORD:-JBkAZin8lytTK6vg}
      - MONGO_HOST=${MONGO_HOST:-cluster0.rnj3vfd.mongodb.net}
      - MONGO_PORT=27017
      - MONGO_INITDB_DATABASE=hypersend
      
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_MAX_CONNECTIONS=100
      - REDIS_SOCKET_TIMEOUT=5
      - REDIS_SOCKET_CONNECT_TIMEOUT=5
      - REDIS_MAX_MEMORY=2gb
      - REDIS_KEYSPACE_ISOLATION=true
      - REDIS_ENCRYPTION_IN_TRANSIT=true
      
      # API Configuration
      - DEBUG=false
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_BASE_URL=${API_BASE_URL:-https://zaply.in.net/api/v1}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-https://zaply.in.net,http://zaply.in.net}
      - RATE_LIMIT_PER_USER=1000
      - RATE_LIMIT_WINDOW_SECONDS=3600
      
      # Email Configuration
      - ENABLE_EMAIL=true
      - ENABLE_PASSWORD_RESET=true
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-noreply@zaply.in.net}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_USE_TLS=true
      - EMAIL_FROM=${EMAIL_FROM:-noreply@zaply.in.net}
      - SENDER_NAME=${SENDER_NAME:-Hypersend Support}
      
      # Abuse Detection
      - ABUSE_SCORING_ENABLED=true
      - ABUSE_SCORE_INITIAL=0.0
      - MESSAGE_VELOCITY_LIMIT_PER_MINUTE=100
      - MESSAGE_VELOCITY_LIMIT_PER_HOUR=1000
      - UNIQUE_RECIPIENTS_DAILY_LIMIT=1000
      - UNIQUE_RECIPIENTS_HOURLY_LIMIT=100
      - SPAM_KEYWORD_SCORE_INCREMENT=0.1
      - VELOCITY_VIOLATION_SCORE_INCREMENT=0.15
      - REPORT_SCORE_INCREMENT=0.2
      - SHADOW_BAN_THRESHOLD=0.6
      - SUSPENSION_THRESHOLD=0.85
      - SHADOW_BAN_DURATION_HOURS=24
      - SUSPENSION_DURATION_HOURS=168
      - SCORE_DECAY_PER_DAY=0.1
      - MODERATION_ENABLED=true
      - AUTO_REPORT_THRESHOLD=0.5
      - EXPLICIT_CONTENT_DETECTION=true
      - PHISHING_DETECTION=true
      
      # TURN Server for Voice/Video Calls
      - TURN_USERNAME=${TURN_USERNAME}
      - TURN_PASSWORD=${TURN_PASSWORD}
      
      # E2EE Secrets
      - E2EE_MASTER_KEY=${E2EE_MASTER_KEY:-secure_e2ee_master_key_2025_fixed}
      - E2EE_SIGNAL_IDENTITY_KEY=${E2EE_SIGNAL_IDENTITY_KEY:-signal_identity_key_base64_encoded}
      - E2EE_SIGNAL_SIGNED_PREKEY=${E2EE_SIGNAL_SIGNED_PREKEY:-signal_signed_prekey_base64_encoded}
      - E2EE_HMAC_SECRET=${E2EE_HMAC_SECRET:-hmac_secret_for_e2ee_signatures}
      - E2EE_KDF_SALT=${E2EE_KDF_SALT:-kdf_salt_for_key_derivation}
      
    volumes:
      - uploads_data:/data
      - redis_data:/redis
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - hypersend_network
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f -s http://127.0.0.1:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  # =============================================================================
  # Frontend Service - Production Ready
  # =============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: mayank035/hypersend-frontend:latest
    container_name: hypersend_frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      - API_BASE_URL=${API_BASE_URL:-https://zaply.in.net/api/v1}
      - DOMAIN_NAME=${DOMAIN_NAME:-zaply.in.net}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - hypersend_network
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f -s http://127.0.0.1/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.2'
        reservations:
          memory: 128M
          cpus: '0.05'

  # =============================================================================
  # WebSocket Service - Real-time Multi-device Support
  # =============================================================================
  # websocket:
  #   build:
  #     context: ./backend
  #     dockerfile: Dockerfile
  #   image: mayank035/hypersend-websocket:latest
  #   container_name: hypersend_websocket
  #   restart: unless-stopped
  #   ports:
  #     - "8001:8001"
  #   command: uvicorn backend.main:app --host 0.0.0.0 --port 8001 --workers 1
  #   environment:
  #     # Core WebSocket Configuration
  #     - SECRET_KEY=${SECRET_KEY:-Prod_Secret_Key_For_Hypersend_2025_Secure_Fixed}
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #     - BACKEND_URL=http://backend:8000
  #     - MAX_CONNECTIONS=10000
  #     - WEBSOCKET_SERVICE=true
      
  #     # Database Configuration (same as backend)
  #     - MONGODB_URI=${MONGODB_URI:-mongodb+srv://mayanllr0311_db_user:JBkAZin8lytTK6vg@cluster0.rnj3vfd.mongodb.net/hypersend?retryWrites=true&w=majority}
  #     - MONGODB_ATLAS_ENABLED=true
      
  #     # E2EE Configuration
  #     - E2EE_ENABLED=true
  #     - E2EE_MASTER_KEY=${E2EE_MASTER_KEY:-secure_e2ee_master_key_2025_fixed}
      
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #     backend:
  #       condition: service_healthy
  #   networks:
  #     - hypersend_network
  #   healthcheck:
  #     test: ["CMD", "sh", "-c", "curl -f -s http://127.0.0.1:8001/health || exit 1"]
  #     interval: 60s
  #     timeout: 30s
  #     retries: 5
  #     start_period: 60s
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M
  #         cpus: '0.25'
        #         memory: 256M
  #         cpus: '0.1'

  # =============================================================================
  # TURN Server for Voice/Video Calls (coturn)
  # =============================================================================
  turn-server:
    image: coturn/coturn:latest
    container_name: hypersend_turn_server
    restart: unless-stopped
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "5349:5349/tcp"
    environment:
      - TURN_USERNAME=${TURN_USERNAME:-turnuser}
      - TURN_PASSWORD=${TURN_PASSWORD}
      - REALM=${DOMAIN_NAME:-zaply.in.net}
    volumes:
      - ./turnserver.conf:/etc/coturn/turnserver.conf:ro
    networks:
      - hypersend_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.1'
        reservations:
          memory: 128M
          cpus: '0.05'

  # =============================================================================
  # Monitoring Services (Optional)
  # =============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: hypersend_prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - hypersend_network
    profiles:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: hypersend_grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - hypersend_network
    profiles:
      - monitoring
